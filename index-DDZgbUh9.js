(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();class M{canvas;emitter;state=new Map;x=0;y=0;constructor(t,e){this.canvas=t,this.emitter=e}onKeyDown=t=>{this.state.set(t.code,!0),t.key===" "&&this.emitter.emit("space")};onKeyUp=t=>{this.state.set(t.code,!1)};onMouseMove=t=>{const e=this.canvas.getBoundingClientRect();this.x=t.clientX-e.left,this.y=t.clientY-e.top};onMouseDown=t=>{t.button===0?this.emitter.emit("leftClick"):t.button===2&&this.emitter.emit("rightClick")};onContextMenu=t=>{t.preventDefault()};init(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),window.addEventListener("mousedown",this.onMouseDown),window.addEventListener("contextmenu",this.onContextMenu),this.canvas.addEventListener("mousemove",this.onMouseMove)}dispose(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),window.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("contextmenu",this.onContextMenu),this.canvas.removeEventListener("mousemove",this.onMouseMove)}}class k{listeners={};on(t,e){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),()=>{this.off(t,e)}}emit(t,...e){if(this.listeners[t])for(const i of this.listeners[t])i(...e)}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(i=>i!==e))}}class h{x;y;constructor(t,e){this.x=t,this.y=e}static radian(t){return new h(Math.sin(t),Math.cos(t)).normalize()}static random(){return new h(Math.random()*2-1,Math.random()*2-1).normalize()}equal(t){return this.x===t.x&&this.y===t.y}empty(){return this.equal(new h(0,0))}add(t){return new h(this.x+t.x,this.y+t.y)}sub(t){return new h(this.x-t.x,this.y-t.y)}dot(t){return this.x*t.x+this.y*t.y}dist(t){const e=this.sub(t);return Math.sqrt(e.x**2+e.y**2)}cross(t){return this.x*t.y-this.y*t.x}scale(t){return new h(this.x*t,this.y*t)}length(){return Math.hypot(this.x,this.y)}normalize(){const t=this.length();return t===0?new h(0,0):this.scale(1/t)}perpendicular(){return new h(-this.y,this.x)}negate(){return new h(-this.x,-this.y)}clone(){return new h(this.x,this.y)}rotate(t){const e=Math.cos(t),i=Math.sin(t);return new h(this.x*e-this.y*i,this.x*i+this.y*e)}}class b{position;width;height;speed;hp;direction;game;constructor(t){this.position=t.position,this.width=t.width,this.height=t.height,this.speed=t.speed,this.hp=t.hp,this.game=t.game,this.direction=new h(0,0)}wouldCollide(t){const e=this.game.scene;if(!e)return!1;for(const i of e.allEntities)if(i.intersect(t,Math.max(this.width,this.height)))return!0;return!1}update(t){if(this.speed===0)return;const e=this.direction.scale(this.speed),i=this.position.add(new h(e.x,0)),r=this.position.add(new h(0,e.y)),n=this.position.add(e);if(t)if(!this.wouldCollide(n))this.position=n;else{let o=!1;this.wouldCollide(i)||(this.position=i,o=!0),this.wouldCollide(r)||(this.position=r,o=!0),o||(this.position=this.position)}else this.wouldCollide(n)||(this.position=n)}}class v{origin;direction;constructor(t,e){this.origin=t,this.direction=e.normalize()}intersect(t){const e=this.origin,i=this.direction,[r,n]=t,o=n.sub(r),c=i.cross(o);if(c===0)return null;const s=r.sub(e),l=s.cross(o)/c,y=s.cross(i)/c;return l>=0&&y>=0&&y<=1?e.add(i.scale(l)):null}reflect(t){const[e,i]=t;let n=i.sub(e).normalize().perpendicular().normalize();n.dot(this.direction)>0&&(n=n.negate());const o=this.direction.dot(n);return this.direction.sub(n.scale(2*o)).normalize()}}class j{gap;count;interval;finite;sx;sy;width;height;timer;index;finished=!1;constructor(t){this.gap=t.gap??0,this.count=t.count??1,this.interval=t.interval??1/0,this.finite=t.finite??this.count===1,this.sx=t.sx,this.sy=t.sy,this.width=t.width,this.height=t.height,this.timer=0,this.index=0}get x(){return this.sx+this.index*(this.width+this.gap)}get y(){return this.sy}reset(){this.timer=0,this.index=0,this.finished=!1}update(t){this.timer+=t,!(this.timer<this.interval||this.finished)&&(this.timer=0,this.index=this.index+1,this.index>=this.count&&(this.finite?(this.index=this.count-1,this.finished=!0):this.index=0))}}class w{resource;frames;localCanvas;localContext;hi=!1;vi=!1;rotation=0;type;frame;constructor(t,e){this.resource=t,this.frames={};for(const[r,n]of Object.entries(e))this.frames[r]=new j(n);const i=Object.keys(e)[0];this.type=i,this.frame=this.frames[i],this.localCanvas=document.createElement("canvas"),this.localCanvas.width=this.frame.width,this.localCanvas.height=this.frame.height,this.localContext=this.localCanvas.getContext("2d"),this.localContext.imageSmoothingEnabled=!1}play(t){t!==this.type&&(this.type=t,this.frame=this.frames[t],this.frame.reset())}update(t){this.frame.update(t)}rotate(t){this.rotation=Math.atan2(t.y,t.x)}draw(t,e,i,r,n){if(!this.frame)return;const o=this.frame,c=r??o.width,s=n??o.height;this.localCanvas.width=c,this.localCanvas.height=s;const l=this.localContext;l.imageSmoothingEnabled=!1,l.clearRect(0,0,c,s),l.save(),l.translate(c/2|0,s/2|0),l.rotate(this.rotation),this.hi&&this.vi?l.scale(-1,-1):this.hi?l.scale(-1,1):this.vi&&l.scale(1,-1),l.drawImage(this.resource.img,o.x,o.y,o.width,o.height,-c/2|0,-s/2|0,c,s),l.restore(),t.drawImage(this.localCanvas,e-c/2|0,i-s/2|0)}}class m{position;direction;game;speed;active=!0;sprite;bounce=0;maxBounces=1/0;constructor(t,e,i,r=4){this.position=t,this.direction=e,this.game=i,this.speed=r,this.sprite=this.game.sprites.ball,this.sprite.play("run"),this.sprite.rotate(e)}update(t){const e=this.game.scene;if(e){if(this.bounce>=this.maxBounces)return this.active=!1,!1;this.position=this.position.add(this.direction.scale(this.speed)),this.sprite.update(t),this.speed*=.9985;for(const i of e.allEntities)if(i){const r=i.intersect(this.position,8);if(r){this.bounce+=1;const n=new v(this.position,this.direction);this.direction=n.reflect(r),this.sprite.rotate(this.direction);break}}return!0}}}class P{character;sprite;game;isAttacking=!1;constructor(t,e){this.game=e,this.character=new b({position:t,width:16,height:16,speed:2.5,hp:100,game:e}),this.sprite=this.game.sprites.cat}init(){this.game.emitter.on("leftClick",this.attack),this.game.emitter.on("rightClick",this.throw)}dispose(){this.game.emitter.off("leftClick",this.attack),this.game.emitter.off("rightClick",this.throw)}attack=()=>{if(!this.isAttacking){this.sprite.play("attack"),this.isAttacking=!0;const t=this.game.scene?.rats??[];for(const e of t)this.character.position.dist(e.character.position)<30&&(e.character.hp-=25)}};throw=()=>{const t=this.game.scene;t&&(t.projectiles.length>1||t.projectiles.push(new m(this.character.position.add(this.ray.direction.scale(10)),this.ray.direction,this.game)))};update(t){const e=this.game.control;let i=new h(0,0);e.state.get("KeyW")&&(i=i.add(new h(0,-1))),e.state.get("KeyS")&&(i=i.add(new h(0,1))),e.state.get("KeyA")&&(i=i.add(new h(-1,0))),e.state.get("KeyD")&&(i=i.add(new h(1,0))),this.character.direction=i.normalize(),this.updateCharacter(t)}updateCharacter(t){const e=this.game.scene;if(!e)return;let i="idle";this.isAttacking?this.sprite.frame.finished?(this.isAttacking=!1,i=this.character.direction.empty()?"idle":"run"):i="attack":i=this.character.direction.empty()?"idle":"run",this.sprite.play(i),this.character.direction.x<0?this.sprite.hi=!0:this.character.direction.x>0&&(this.sprite.hi=!1);for(const r of e.projectiles)if(r.position.dist(this.character.position)<=Math.max(this.character.width,this.character.height)){r.speed<2&&(r.active=!1);break}this.character.update(!0),this.sprite.update(t)}draw(t){this.game.scene?._debug&&(t.fillStyle="red",t.beginPath(),t.ellipse(this.character.position.x,this.character.position.y,this.character.width,this.character.height,Math.PI/4,0,360),t.fill()),this.sprite.draw(t,this.character.position.x,this.character.position.y,this.character.width*3,this.character.height*3)}get ray(){const t=this.game.control.y,e=this.game.control.x,i=new h(e,t).sub(this.character.position).normalize();return new v(this.character.position,i)}}class D{canvas;context;frameId=-1;fps_timestamp=-1;fps_interval;scene;constructor(t){this.canvas=t,this.context=this.canvas.getContext("2d",{alpha:!1});const e=window.devicePixelRatio,i=t.getBoundingClientRect();t.width=i.width*e,t.height=i.height*e,this.context.scale(e,e),t.style.width=`${i.width}px`,t.style.height=`${i.height}px`,this.context.imageSmoothingEnabled=!1,this.fps_interval=1e3/60}tick=()=>{this.frameId=requestAnimationFrame(this.tick);const t=Date.now(),e=t-this.fps_timestamp;e<this.fps_interval||(this.fps_timestamp=t-e%this.fps_interval,this.scene&&(this.scene.update(e),this.scene.draw(this.context)))};start(){this.tick()}stop(){cancelAnimationFrame(this.frameId)}}class S{resources={};sprites={};emitter=new k;control;renderer;player;scene;constructor(t){this.renderer=new D(t),this.control=new M(t,this.emitter)}load(){return Promise.all(Object.values(this.resources).map(t=>t.load()))}init(){return this.player=new P(new h(300,300),this),this.player.init(),this.control.init(),Promise.resolve()}setScene(t){this.scene=t,this.scene.game=this,this.renderer.scene=this.scene}}class g{source;loaded=!1;img;constructor(t){this.source=t,this.img=new Image}get width(){return this.img.width}get height(){return this.img.height}load(){return new Promise((t,e)=>{this.img.onload=()=>{this.loaded=!0,t()},this.img.onerror=i=>{e(i)},this.img.src=this.source})}}class p{position;vectors;color;constructor(t,e,i={color:"#000"}){this.position=t,this.vectors=e,this.color=i.color}static line(t,e,i){return new p(t,[e,i])}static square(t,e){const i=e/2|0;return new p(t,[new h(-i,-i),new h(i,-i),new h(i,i),new h(-i,i)])}static polygon(t,e,i="#fff"){return new p(t,e.map(([r,n])=>new h(r,n)),{color:i})}*gen(){for(let t=1;t<this.vectors.length;t++)yield[this.vectors[t-1].add(this.position),this.vectors[t].add(this.position)];yield[this.vectors[this.vectors.length-1].add(this.position),this.vectors[0].add(this.position)]}get lines(){return[...this.gen()]}rotate(t){const e=Math.atan2(t.y,t.x);for(let i=0;i<this.vectors.length;i++)this.vectors[i]=this.vectors[i].rotate(e)}move(t){this.position=this.position.add(t)}static lineIntersect(t,e,i){const[r,n]=e,o=n.sub(r),c=t.sub(r),s=o.dot(o);if(s===0)return t.sub(r).length()<=i;const l=c.dot(o)/s,y=Math.max(0,Math.min(1,l)),C=r.add(o.scale(y));return t.sub(C).length()<=i}intersect(t,e=0){for(const i of this.lines)if(p.lineIntersect(t,i,e))return i;return null}draw(t){t.beginPath(),t.setLineDash([]),t.strokeStyle=this.color,t.lineWidth=1;const e=this.vectors[0].add(this.position);t.moveTo(e.x,e.y);for(let i=0;i<this.vectors.length;i++){const r=this.vectors[i].add(this.position);t.lineTo(r.x,r.y)}t.lineTo(e.x,e.y),t.stroke()}update(t){}}class d{position;width;height;entity;sprite;frame;finite;hb;hi;vi;constructor(t,e,i,r,n,o={}){if(this.position=new h(t[0],t[1]),this.sprite=r,this.width=e,this.height=i,this.frame=n,this.hb=o.hb??!0,this.hi=o.hi??!1,this.vi=o.vi??!1,this.finite=this.sprite.frame.finite,this.hb){const c=e/2|0,s=i/2|0;this.entity=p.polygon(this.position,[[-c,-s],[c,-s],[c,s],[-c,s]],"red")}}update(t){this.finite||this.sprite.update(t)}draw(t){this.sprite.hi=this.hi,this.sprite.vi=this.vi,this.sprite.play(this.frame),this.sprite.draw(t,this.position.x,this.position.y,this.width,this.height)}}class f{game;character;counter=0;current=0;sprite;cooldown=0;cooldownCounter=0;state="run";constructor(t,e){this.game=e,this.character=new b({width:20,height:20,speed:2.8,position:t,hp:100,game:e}),this.sprite=new w(e.resources.rat,{run:{width:32,height:32,gap:0,count:10,interval:200,finite:!1,sx:2,sy:80},death:{width:32,height:32,gap:0,count:10,interval:200,finite:!0,sx:2,sy:140}}),this.character.direction=h.random(),this.state="run",this.sprite.play("run"),this.setCounter()}setCounter(){this.current=0,this.counter=150+Math.floor(Math.random()*400)}update(t){const e=this.game.scene;if(!e)return;const i=this.character.position.clone();if(this.current+=1,this.current===this.counter&&(this.character.direction=h.random(),this.setCounter()),this.state==="caught"&&(this.cooldownCounter+=1),this.cooldownCounter===this.cooldown&&(this.state="run",this.sprite.play("run")),this.state==="run"){for(this.character.update(!1);this.character.position.equal(i);)this.character.direction=h.random(),this.character.update(!1);for(const r of e.projectiles)if(r.position.dist(this.character.position)<=16&&r.speed>2){this.state="caught",this.sprite.play("death"),this.cooldown=250,this.cooldownCounter=0;break}}this.character.direction.x<0?this.sprite.hi=!1:this.character.direction.x>0&&(this.sprite.hi=!0),this.sprite.update(t)}}class E{sceneDraw;entities=[];objects2D=[];projectiles=[];rats=[];game;_debug=!1;constructor(t){this.sceneDraw=t}*gen(){for(const t of this.entities)yield t;for(const t of this.objects2D)t.entity&&(yield t.entity)}get allEntities(){return[...this.gen()]}update(t){this.game?.player?.update(t);for(const e of this.entities)e.update(t);for(const e of this.objects2D)e.update(t);for(let e=0;e<this.projectiles.length;e++)this.projectiles[e].update(t),this.projectiles[e].active||(this.projectiles.splice(e,1),e-=1);for(let e=0;e<this.rats.length;e++)this.rats[e].update(t),this.rats[e].character.hp<=0&&(this.rats.splice(e,1),e-=1)}draw(t){this.sceneDraw(t);for(const e of this.objects2D)e.draw(t),this._debug&&e.entity?.draw(t);for(const e of this.projectiles)e.sprite.draw(t,e.position.x,e.position.y,16,16);for(const e of this.rats){const i=e.character.position.x,r=e.character.position.y;e.sprite.draw(t,i,r,64,64),t.beginPath(),t.fillStyle="red",t.rect(i-10,r-32,32,4),t.fill(),t.closePath(),t.beginPath(),t.fillStyle="green",t.rect(i-10,r-32,32*(e.character.hp/100),4),t.fill(),t.closePath()}if(this.game?.player?.draw(t),this._debug)for(const e of this.entities)e.draw(t)}}const L=a=>{const n=new E(s=>{s.fillStyle="#b0b897",s.fillRect(36,108,700,500),s.fillStyle="#545046",s.beginPath(),s.rect(0,0,36,576),s.rect(0,0,384,36),s.rect(384,0,36,72),s.rect(732,220,732,356),s.rect(0,540,768,576),s.rect(384,72,384,36),s.rect(732,72,36,504),s.fill(),s.closePath(),s.beginPath(),s.fillStyle="#6e6244",s.rect(36,36,348,150),s.fill(),s.closePath(),s.beginPath(),s.fillStyle="#445216",s.rect(384,108,350,150),s.fill(),s.closePath(),s.beginPath(),s.fillStyle="#a6b379";for(let l=0;l<20;l++)s.rect(384+l*36/2,108,6,150);s.fill(),s.closePath(),s.beginPath(),s.fillStyle="#ffffff",s.rect(36,180,348,6),s.rect(36,180,6,360),s.rect(36,534,696,6),s.rect(378,180,6,84),s.rect(378,258,354,6),s.rect(726,258,6,280),s.fill(),s.closePath()}),o=a.sprites.furniture,c=!1;return n.objects2D=[new d([450,210],48,96,o,"door",{hb:c}),new d([604,180],48,96,o,"window",{hb:c}),new d([654,180],48,96,o,"window",{hb:c}),new d([174,106],61*4.5,32*4.5+3,o,"kitchen",{hb:c}),new d([346,108],74,144,o,"fridge",{hb:c}),new d([210,350],128,64,o,"table"),new d([190,380],26,40,o,"chair_ver_1"),new d([230,380],26,40,o,"chair_ver_1"),new d([580,300],128,64,o,"tv_table"),new d([580,280],128,64,o,"tv"),new d([550,420],39,39,o,"chair2"),new d([600,420],39,39,o,"chair2")],n.entities=[p.polygon(new h(384,360),[[-342,-174],[-6,-174],[-6,-96],[342,-96],[342,174],[-342,174]],"red")],n.projectiles.push(new m(new h(380,290),new h(0,0),a,0)),n.projectiles.push(new m(new h(74,500),new h(0,0),a,0)),n.rats.push(new f(new h(64,400),a)),n.rats.push(new f(new h(64,400),a)),n.rats.push(new f(new h(64,400),a)),n.rats.push(new f(new h(64,400),a)),n.rats.push(new f(new h(64,400),a)),n.rats.push(new f(new h(64,400),a)),n.rats.push(new f(new h(64,400),a)),n},x=document.getElementById("app");if(!x)throw new Error;const u=new S(x);u.resources={furniture:new g("public/sprites/furniture.png"),interior:new g("public/sprites/interior.png"),cat:new g("public/sprites/cat.png"),ball:new g("public/sprites/ball.png"),rat:new g("public/sprites/rat.png")};u.sprites={furniture:new w(u.resources.furniture,{table:{width:32,height:16,sx:0,sy:17},sofa:{width:32,height:16,sx:34,sy:85},fridge:{width:16,height:32,sx:204,sy:290},kitchen:{width:61,height:32,sx:442,sy:119},chair_hor:{width:11,height:15,sx:2,sy:35},chair_ver_1:{width:10,height:15,sx:3,sy:52},chair_ver_2:{width:10,height:15,sx:20,sy:52},door:{width:16,height:32,sx:340,sy:120},window:{width:16,height:32,sx:17,sy:69},tv:{width:32,height:16,sx:153,sy:85},tv_table:{width:32,height:14,sx:306,sy:70},chair2:{width:13,height:13,sx:307,sy:172}}),interior:new w(u.resources.interior,{corner:{width:8,height:8,sx:27,sy:100},wall:{width:8,height:8,sx:9,sy:0},wall2:{width:8,height:8,sx:18,sy:0},floor:{width:8,height:8,sx:0,sy:9}}),cat:new w(u.resources.cat,{idle:{width:16,height:16,gap:0,count:4,interval:250,finite:!1,sx:0,sy:4},run:{width:16,height:16,gap:0,count:4,interval:200,finite:!1,sx:0,sy:36},attack:{width:16,height:16,gap:0,count:4,interval:100,finite:!0,sx:0,sy:84},death:{width:16,height:16,gap:0,count:4,interval:250,finite:!0,sx:0,sy:212}}),ball:new w(u.resources.ball,{run:{width:32,height:32,gap:0,count:4,interval:200,finite:!1,sx:0,sy:0}}),rat:new w(u.resources.rat,{run:{width:32,height:32,gap:0,count:8,interval:200,finite:!1,sx:2,sy:103}})};const I=L(u);u.setScene(I);u.load().then(()=>u.init()).then(()=>u.renderer.start());
