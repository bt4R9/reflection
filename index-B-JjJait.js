(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();class s{x;y;constructor(t,e){this.x=t,this.y=e}equal(t){return this.x===t.x&&this.y===t.y}add(t){return new s(this.x+t.x,this.y+t.y)}sub(t){return new s(this.x-t.x,this.y-t.y)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}scale(t){return new s(this.x*t,this.y*t)}length(){return Math.hypot(this.x,this.y)}normalize(){const t=this.length();return t===0?new s(0,0):this.scale(1/t)}perpendicular(){return new s(-this.y,this.x)}negate(){return new s(-this.x,-this.y)}clone(){return new s(this.x,this.y)}rotate(t){const e=Math.cos(t),i=Math.sin(t);return new s(this.x*e-this.y*i,this.x*i+this.y*e)}}class p{p1;p2;constructor(t,e){this.p1=t,this.p2=e}get center(){return new s((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2)}get radius(){return this.p1.sub(this.p2).length()/2}intersect(t,e=4){const i=this.p1,r=this.p2.sub(i),h=t.sub(i),a=r.dot(r);if(a===0)return t.sub(i).length()<=e;const l=h.dot(r)/a,u=Math.max(0,Math.min(1,l)),d=i.add(r.scale(u));return t.sub(d).length()<=e}}class o{lines=[];_center;_radius;velocity;speed;rotation;constructor(t,e){this.lines=t,this._center=e,this.velocity=new s(0,0),this.speed=0,this.rotation=0}get center(){if(this._center)return this._center;const t=this.lines.reduce((i,n)=>i+(n.p1.x+n.p2.x)/2,0)/this.lines.length,e=this.lines.reduce((i,n)=>i+(n.p1.y+n.p2.y)/2,0)/this.lines.length;return this._center=new s(t,e),this._center}get radius(){return this._radius?this._radius:(this._radius=this.lines.reduce((t,e)=>{const i=e.p1,n=e.p2,r=i.sub(this.center).length(),h=n.sub(this.center).length();return Math.max(t,r,h)},0),this._radius)}static line(t,e){return new o([new p(t,e)])}static square(t,e){const i=e/2|0,n=[new p(new s(t.x-i,t.y-i),new s(t.x+i,t.y-i)),new p(new s(t.x+i,t.y-i),new s(t.x+i,t.y+i)),new p(new s(t.x+i,t.y+i),new s(t.x-i,t.y+i)),new p(new s(t.x-i,t.y+i),new s(t.x-i,t.y-i))];return new o(n,t)}rotate(t){const e=this.center;for(const i of this.lines)i.p1=i.p1.sub(e).rotate(t).add(e),i.p2=i.p2.sub(e).rotate(t).add(e);return this}move(t){for(const e of this.lines)e.p1=e.p1.add(t),e.p2=e.p2.add(t);return this._center&&(this._center=this._center.add(t)),this}static polygon(t){const e=[],i=t[0],n=t[t.length-1];for(let r=1;r<t.length;r++)e.push(new p(t[r-1],t[r]));return e.push(new p(n,i)),new o(e)}update(){this.velocity.length()>0&&this.move(this.velocity.scale(this.speed)),this.rotation!==0&&this.rotate(this.rotation)}}class k{canvas;context;frameId=-1;fps_timestamp=-1;fps_interval;world;tracking=!0;constructor(t,e){this.canvas=t,this.context=this.canvas.getContext("2d",{alpha:!1});const i=window.devicePixelRatio,n=t.getBoundingClientRect();t.width=n.width*i,t.height=n.height*i,this.context.scale(i,i),t.style.width=`${n.width}px`,t.style.height=`${n.height}px`,this.context.imageSmoothingEnabled=!1,this.world=e,this.fps_interval=1e3/60}tick=()=>{this.frameId=requestAnimationFrame(this.tick);const t=Date.now(),e=t-this.fps_timestamp;e<this.fps_interval||(this.fps_timestamp=t-e%this.fps_interval,this.world.update(e),this.draw())};start(){this.tick(),this.world.emitter.on("space",()=>{this.tracking=!this.tracking})}stop(){cancelAnimationFrame(this.frameId)}draw=()=>{const t=this.context,e=this.world;t.fillStyle="#000",t.fillRect(0,0,800,600);for(const i of e.entities)this.drawEntity(i);this.drawPlayer(e),this.drawProjectiles(e),this.drawEffects(e)};drawEffects(t){const e=this.context;for(const i of t.effects)i.sprite.draw(e,i.position.x,i.position.y)}drawPlayer(t){const e=this.context,i=t.player.character.sprite;if(i&&i.loaded){const n=t.player.character.position;i.draw(e,n.x,n.y)}}drawProjectiles(t){const e=this.context;for(const i of t.projectiles)i.sprite.draw(e,i.position.x,i.position.y)}drawTraces(t){if(t.traced.length===1)return;const e=this.context;let i=t.traced[0];for(let n=1;n<t.traced.length;n++){const r=t.traced[n];e.strokeStyle="black",e.beginPath(),e.setLineDash([3,3]),e.moveTo(i.x,i.y),e.lineTo(r.x,r.y),e.stroke(),e.fillStyle=n===t.traced.length-1?"red":"blue",e.beginPath(),e.ellipse(r.x,r.y,6,6,Math.PI/4,0,360),e.fill(),i=r}}drawEntity(t){const e=this.context,i=t.lines.flatMap(n=>[n.p1,n.p2]);e.beginPath(),e.setLineDash([]),e.strokeStyle="#fff",e.lineWidth=1,e.moveTo(i[0].x,i[0].y);for(let n=1;n<i.length;n++)e.lineTo(i[n].x,i[n].y);e.stroke()}}class w{origin;direction;constructor(t,e){this.origin=t,this.direction=e.normalize()}intersect(t){const e=this.origin,i=this.direction,n=t.p1,h=t.p2.sub(n),a=i.cross(h);if(a===0)return null;const l=n.sub(e),u=l.cross(h)/a,d=l.cross(i)/a;return u>=0&&d>=0&&d<=1?e.add(i.scale(u)):null}reflect(t){const e=this.direction.dot(t);return this.direction.sub(t.scale(2*e)).normalize()}}class z{world;constructor(t){this.world=t}cast(t,e=4){let i=t;const n=[t.origin];for(let r=0;r<e;r++){let h=null,a=null,l=1/0;for(let P of this.world.entities)for(const x of P.lines){const m=i.intersect(x);if(m){const v=m.sub(i.origin).length();v<l&&(l=v,h=m,a=x)}}if(!h||!a)break;h=h.add(i.direction.scale(.001)),n.push(h);let d=a.p2.sub(a.p1).normalize().perpendicular().normalize();d.dot(i.direction)>0&&(d=d.negate());const y=i.reflect(d);i=new w(h.add(y.scale(.01)),y)}return n}}class D{canvas;emitter;state=new Map;x=0;y=0;constructor(t,e){this.canvas=t,this.emitter=e}onKeyDown=t=>{this.state.set(t.key,!0),t.key===" "&&this.emitter.emit("space")};onKeyUp=t=>{this.state.set(t.key,!1)};onMouseMove=t=>{const e=this.canvas.getBoundingClientRect();this.x=t.clientX-e.left,this.y=t.clientY-e.top};onMouseDown=()=>{this.emitter.emit("mousedown")};init(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),window.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("mousemove",this.onMouseMove)}dispose(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),window.addEventListener("mousedown",this.onMouseDown),this.canvas.removeEventListener("mousemove",this.onMouseMove)}}class I{listeners={};on(t,e){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),()=>{this.off(t,e)}}emit(t,...e){if(this.listeners[t])for(const i of this.listeners[t])i(...e)}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(i=>i!==e))}}class j{position;velocity;width;height;speed;sprite;constructor(t){this.position=t.position,this.sprite=t.sprite,this.width=t.width,this.height=t.height,this.speed=t.speed,this.velocity=new s(0,0)}move(){this.speed!==0&&(this.position=this.position.add(this.velocity.scale(this.speed)))}update(){this.move()}}class q{sprite;width;height;gap;count;interval;finite;x;y;timer;index;finished=!1;constructor(t,e){this.sprite=t,this.width=e.width,this.height=e.height,this.gap=e.gap,this.count=e.count,this.interval=e.interval,this.finite=e.finite,this.x=e.x,this.y=e.y,this.timer=0,this.index=0}reset(){this.timer=0,this.index=0}update(t){this.timer+=t,!(this.timer<this.interval)&&(this.timer=0,this.index=this.index+1,this.index>=this.count&&(this.finite?this.finished=!0:this.index=0))}}class g{loaded=!1;source;sprite;frames;width;height;localCanvas;localContext;type="idle";hotizontalInverse=!1;rotation=0;frame;constructor(t,e,i,n){this.source=t,this.width=e,this.height=i,this.sprite=new Image,this.frames={};for(const[r,h]of Object.entries(n))this.frames[r]=new q(this.sprite,h);this.localCanvas=document.createElement("canvas"),this.localCanvas.width=this.width,this.localCanvas.height=this.height,this.localContext=this.localCanvas.getContext("2d"),this.localContext.imageSmoothingEnabled=!1,this.frame=this.frames[this.type],this.load()}load(){return new Promise((t,e)=>{this.sprite.onload=()=>{this.loaded=!0,t()},this.sprite.onerror=i=>{this.loaded=!1,e(i)},this.sprite.src=this.source})}play(t){t!==this.type&&(this.type=t,this.frame=this.frames[t],this.frame?.reset())}update(t){this.frame?.update(t)}rotate(t){this.rotation=Math.atan2(t.y,t.x)}draw(t,e,i){if(!this.frame)return;const n=this.localContext,r=this.frame.x+this.frame.index*(this.frame.width+this.frame.gap),h=this.frame.y;n.clearRect(0,0,this.width,this.height),n.save(),n.translate(this.width/2,this.height/2),n.rotate(this.rotation),this.hotizontalInverse&&n.scale(-1,1),n.drawImage(this.sprite,r,h,this.frame.width,this.frame.height,-this.frame.width/2,-this.frame.height/2,this.frame.width,this.frame.height),n.restore(),t.drawImage(this.localCanvas,e-this.width/2|0,i-this.height/2|0)}}class _{position;sprite;constructor(t){this.position=t,this.sprite=new g("public/explode.png",50,50,{run:{width:50,height:50,gap:0,count:7,interval:250,finite:!0,x:0,y:0}}),this.sprite.play("run")}update(t){this.sprite.update(t)}get finished(){return this.sprite.frame?.finished??!1}}class S{position;direction;world;speed=2.5;active=!0;sprite;bounce=0;maxBounces=2;constructor(t,e,i){this.position=t,this.direction=e,this.world=i,this.sprite=new g("public/moving.png",50,50,{run:{width:50,height:50,gap:0,count:4,interval:250,finite:!1,x:0,y:0}}),this.sprite.play("run"),this.sprite.rotate(e)}update(t){if(this.bounce>=this.maxBounces)return this.active=!1,this.world.effects.push(new _(this.position)),!1;this.position=this.position.add(this.direction.scale(this.speed)),this.sprite.update(t);for(const e of this.world.entities)for(const i of e.lines)if(i.intersect(this.position)){this.bounce++;const n=new w(this.position,this.direction);if(n.intersect(i)){let a=i.p2.sub(i.p1).normalize().perpendicular().normalize();a.dot(n.direction)>0&&(a=a.negate());const l=n.reflect(a);this.direction=l,this.sprite.rotate(this.direction)}break}return!0}}class R{character;world;constructor(t,e){this.character=new j({position:t,width:64,height:64,speed:2,sprite:new g("public/mage.png",48,64,{idle:{width:64,height:64,gap:76,count:10,interval:250,finite:!1,x:0,y:0},run:{width:64,height:64,gap:76,count:8,interval:100,finite:!1,x:0,y:80}})}),this.world=e,this.updateCharacter(0)}fire=()=>{this.world.projectiles.push(new S(this.character.position,this.ray.direction,this.world))};init(){this.world.emitter.on("mousedown",this.fire)}dispose(){this.world.emitter.off("mousedown",this.fire)}update(t){const e=this.world.control;let i=new s(0,0);this.character.speed=0,e.state.get("w")&&(this.character.speed=1,i=i.add(new s(0,-1))),e.state.get("s")&&(this.character.speed=1,i=i.add(new s(0,1))),e.state.get("a")&&(this.character.speed=1,i=i.add(new s(-1,0))),e.state.get("d")&&(this.character.speed=1,i=i.add(new s(1,0))),this.character.velocity=i.normalize(),this.updateCharacter(t)}updateCharacter(t){const e=this.character.speed>0?"run":"idle",i=this.character.sprite;i&&(this.character.velocity.x<0?this.character.sprite.hotizontalInverse=!0:this.character.velocity.x>0&&(this.character.sprite.hotizontalInverse=!1),i.play(e),this.character.velocity.x<0?i.hotizontalInverse=!0:this.character.velocity.x>0&&(i.hotizontalInverse=!1),this.character.update(),this.character.move(),i.update(t))}get ray(){const t=this.world.control.y,e=this.world.control.x,i=new s(e,t).sub(this.character.position).normalize();return new w(this.character.position,i)}}class K{entities=[];effects=[];projectiles=[];ray;casting;traced=[];emitter=new I;player;control;constructor(t){this.ray=new w(new s(400,300),new s(-.5,-.9)),this.casting=new z(this),this.control=new D(t,this.emitter),this.player=new R(new s(400,300),this)}add(t){return this.entities.push(t),this}update(t){for(const e of this.entities)e.update();for(let e=0;e<this.effects.length;e++)this.effects[e].update(t),this.effects[e].finished&&(this.effects.splice(e,1),e--);for(let e=0;e<this.projectiles.length;e++){const i=this.projectiles[e];i.update(t),i.active||(this.projectiles.splice(e,1),e--)}this.player.update(t),this.trace()}trace(){this.traced=this.casting.cast(this.player.ray)}}class O{renderer;world;constructor(t){this.world=new K(t),this.renderer=new k(t,this.world)}start(){this.world.control.init(),this.world.player.init(),this.renderer.start()}stop(){this.world.control.dispose(),this.world.player.dispose(),this.renderer.stop()}}const b=document.getElementById("app");if(!b)throw new Error("No canvas element found");const C=new O(b),f=C.world;f.add(o.line(new s(1,1),new s(799,1))).add(o.line(new s(1,599),new s(799,599))).add(o.line(new s(1,1),new s(1,599))).add(o.line(new s(799,1),new s(799,599)));f.add(o.line(new s(40,40),new s(300,20))).add(o.line(new s(300,20),new s(500,30))).add(o.line(new s(500,30),new s(750,10))).add(o.line(new s(750,10),new s(790,250))).add(o.line(new s(790,250),new s(750,300))).add(o.line(new s(750,300),new s(790,350))).add(o.line(new s(790,350),new s(780,590))).add(o.line(new s(780,590),new s(600,550))).add(o.line(new s(600,550),new s(400,560))).add(o.line(new s(400,560),new s(200,595))).add(o.line(new s(200,595),new s(190,500))).add(o.line(new s(190,500),new s(150,595))).add(o.line(new s(150,595),new s(30,490))).add(o.line(new s(30,490),new s(50,290))).add(o.line(new s(50,290),new s(10,140))).add(o.line(new s(10,140),new s(40,40)));const M=o.square(new s(250,250),75),E=o.square(new s(450,450),90),L=o.square(new s(550,200),90);M.rotation=-.01;E.rotation=.02;L.rotation=.005;f.add(M).add(E).add(L);const B=o.polygon([new s(100,100),new s(150,50),new s(50,100)]);f.add(B);C.start();
