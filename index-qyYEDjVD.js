(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();class w{p1;p2;constructor(t,e){this.p1=t,this.p2=e}intersect(t,e=4){const s=this.p1,o=this.p2.sub(s),l=t.sub(s),a=o.dot(o);if(a===0)return t.sub(s).length()<=e;const d=l.dot(o)/a,u=Math.max(0,Math.min(1,d)),h=s.add(o.scale(u));return t.sub(h).length()<=e}}class i{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return new i(this.x+t.x,this.y+t.y)}sub(t){return new i(this.x-t.x,this.y-t.y)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}scale(t){return new i(this.x*t,this.y*t)}length(){return Math.hypot(this.x,this.y)}normalize(){const t=this.length();return t===0?new i(0,0):this.scale(1/t)}perpendicular(){return new i(-this.y,this.x)}negate(){return new i(-this.x,-this.y)}clone(){return new i(this.x,this.y)}rotate(t){const e=Math.cos(t),s=Math.sin(t);return new i(this.x*e-this.y*s,this.x*s+this.y*e)}}class r{lines=[];_center;_radius;velocity;speed;rotation;constructor(t,e){this.lines=t,this._center=e,this.velocity=new i(0,0),this.speed=0,this.rotation=0}get center(){if(this._center)return this._center;const t=this.lines.reduce((s,n)=>s+(n.p1.x+n.p2.x)/2,0)/this.lines.length,e=this.lines.reduce((s,n)=>s+(n.p1.y+n.p2.y)/2,0)/this.lines.length;return this._center=new i(t,e),this._center}get radius(){return this._radius?this._radius:(this._radius=this.lines.reduce((t,e)=>{const s=e.p1,n=e.p2,o=s.sub(this.center).length(),l=n.sub(this.center).length();return Math.max(t,o,l)},0),this._radius)}static line(t,e){return new r([new w(t,e)])}static square(t,e){const s=e/2|0,n=[new w(new i(t.x-s,t.y-s),new i(t.x+s,t.y-s)),new w(new i(t.x+s,t.y-s),new i(t.x+s,t.y+s)),new w(new i(t.x+s,t.y+s),new i(t.x-s,t.y+s)),new w(new i(t.x-s,t.y+s),new i(t.x-s,t.y-s))];return new r(n,t)}rotate(t){const e=this.center;for(const s of this.lines)s.p1=s.p1.sub(e).rotate(t).add(e),s.p2=s.p2.sub(e).rotate(t).add(e);return this}move(t){for(const e of this.lines)e.p1=e.p1.add(t),e.p2=e.p2.add(t);return this._center&&(this._center=this._center.add(t)),this}static polygon(t){const e=[],s=t[0],n=t[t.length-1];for(let o=1;o<t.length-1;o++)e.push(new w(t[o-1],t[o]));return e.push(new w(n,s)),new r(e)}update(){this.velocity.length()>0&&this.move(this.velocity.scale(this.speed)),this.rotation!==0&&this.rotate(this.rotation)}}class k{canvas;context;frameId=-1;fps_timestamp=-1;fps_interval;world;tracking=!0;constructor(t,e){this.canvas=t,this.context=this.canvas.getContext("2d",{alpha:!1});const s=window.devicePixelRatio,n=t.getBoundingClientRect();t.width=n.width*s,t.height=n.height*s,this.context.scale(s,s),t.style.width=`${n.width}px`,t.style.height=`${n.height}px`,this.world=e,this.fps_interval=1e3/60}tick=()=>{this.frameId=requestAnimationFrame(this.tick);const t=Date.now(),e=t-this.fps_timestamp;e<this.fps_interval||(this.fps_timestamp=t-e%this.fps_interval,this.world.update(),this.draw())};start(){this.tick(),this.world.emitter.on("space",()=>{this.tracking=!this.tracking})}stop(){cancelAnimationFrame(this.frameId)}draw=()=>{const t=this.context,e=this.world;t.fillStyle="#fff",t.fillRect(0,0,800,600);for(const s of e.entities)this.drawEntity(s);t.fillStyle="green",t.beginPath(),t.ellipse(e.player.position.x,e.player.position.y,10,10,Math.PI/4,0,360),t.fill(),this.tracking&&this.drawTraces(e),this.drawPlayer(e),this.drawEffects(e)};drawEffects(t){const e=this.context;for(const s of t.effects)e.fillStyle="red",e.beginPath(),e.ellipse(s.position.x,s.position.y,s.value,s.value,Math.PI/4,0,360),e.fill()}drawPlayer(t){const e=this.context,s=t.player.bullets;for(const n of s){const o=1-n.bounce/10,l=parseInt("#ff0000".slice(1,3),16),a=parseInt("ff0000".slice(3,5),16),d=parseInt("ff0000".slice(5,7),16),u=Math.round(l*o),h=Math.round(a*o),p=Math.round(d*o);e.fillStyle=`#${u.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}`,e.beginPath(),e.ellipse(n.position.x,n.position.y,4,4,Math.PI/4,0,360),e.fill()}}drawTraces(t){if(t.traced.length===1)return;const e=this.context;let s=t.traced[0];for(let n=1;n<t.traced.length;n++){const o=t.traced[n];e.strokeStyle="black",e.beginPath(),e.setLineDash([3,3]),e.moveTo(s.x,s.y),e.lineTo(o.x,o.y),e.stroke(),e.fillStyle=n===t.traced.length-1?"red":"blue",e.beginPath(),e.ellipse(o.x,o.y,6,6,Math.PI/4,0,360),e.fill(),s=o}}drawEntity(t){const e=this.context,s=t.lines.flatMap(n=>[n.p1,n.p2]);e.beginPath(),e.setLineDash([]),e.strokeStyle="black",e.lineWidth=1,e.moveTo(s[0].x,s[0].y);for(let n=1;n<s.length;n++)e.lineTo(s[n].x,s[n].y);e.stroke()}}class y{origin;direction;constructor(t,e){this.origin=t,this.direction=e.normalize()}intersect(t){const e=this.origin,s=this.direction,n=t.p1,l=t.p2.sub(n),a=s.cross(l);if(a===0)return null;const d=n.sub(e),u=d.cross(l)/a,h=d.cross(s)/a;return u>=0&&h>=0&&h<=1?e.add(s.scale(u)):null}reflect(t){const e=this.direction.dot(t);return this.direction.sub(t.scale(2*e)).normalize()}}class I{world;constructor(t){this.world=t}cast(t,e=10){let s=t;const n=[t.origin];for(let o=0;o<e;o++){let l=null,a=null,d=1/0;for(let P of this.world.entities)for(const g of P.lines){const m=s.intersect(g);if(m){const b=m.sub(s.origin).length();b<d&&(d=b,l=m,a=g)}}if(!l||!a)break;l=l.add(s.direction.scale(.001)),n.push(l);let h=a.p2.sub(a.p1).normalize().perpendicular().normalize();h.dot(s.direction)>0&&(h=h.negate());const p=s.reflect(h);s=new y(l.add(p.scale(.01)),p)}return n}}class D{canvas;emitter;state=new Map;x=0;y=0;constructor(t,e){this.canvas=t,this.emitter=e}onKeyDown=t=>{this.state.set(t.key,!0),t.key===" "&&this.emitter.emit("space")};onKeyUp=t=>{this.state.set(t.key,!1)};onMouseMove=t=>{const e=this.canvas.getBoundingClientRect();this.x=t.clientX-e.left,this.y=t.clientY-e.top};onMouseDown=()=>{this.emitter.emit("mousedown")};subscribe(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),window.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("mousemove",this.onMouseMove)}unsubscribe(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),window.addEventListener("mousedown",this.onMouseDown),this.canvas.removeEventListener("mousemove",this.onMouseMove)}}class S{listeners={};on(t,e){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),()=>{this.off(t,e)}}emit(t,...e){if(this.listeners[t])for(const s of this.listeners[t])s(...e)}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(s=>s!==e))}}class q{position;start;end;value;duration;startTime;constructor(t,e,s,n){this.position=t,this.start=e,this.end=s,this.duration=n,this.value=e,this.startTime=performance.now()}update(){const e=performance.now()-this.startTime,s=Math.min(e/this.duration,1);this.value=z(s,this.start,this.end)}}function _(c){return c<.5?4*c*c*c:1-Math.pow(-2*c+2,3)/2}function z(c,t,e){const s=_(c);return t+(e-t)*s}class T{position;direction;speed=2.5;active=!0;world;bounce=0;maxBounces=5;constructor(t,e,s){this.position=t,this.direction=e,this.world=s}update(){if(this.bounce>=this.maxBounces)return this.active=!1,this.world.effects.push(new q(this.position,3,100,3e3)),!1;this.position=this.position.add(this.direction.scale(this.speed));for(const t of this.world.entities)for(const e of t.lines)if(e.intersect(this.position)){this.bounce++,this.speed*=.95;const s=new y(this.position,this.direction);if(s.intersect(e)){let l=e.p2.sub(e.p1).normalize().perpendicular().normalize();l.dot(s.direction)>0&&(l=l.negate());const a=s.reflect(l);this.direction=a}break}return!0}}class O{position;velocity;speed;world;bullets=[];constructor(t,e,s){this.position=t,this.velocity=new i(0,0),this.speed=e,this.world=s}fire=()=>{this.bullets.push(new T(this.position,this.ray.direction,this.world))};subscribe(){this.world.emitter.on("mousedown",this.fire)}unsubscribe(){this.world.emitter.off("mousedown",this.fire)}get ray(){const t=this.world.control.y,e=this.world.control.x,s=new i(e,t).sub(this.position).normalize();return new y(this.position,s)}move(t){this.velocity=t.normalize().scale(this.speed),this.speed!==0&&(this.position=this.position.add(this.velocity))}update(){const t=this.world.control;this.speed=0,t.state.get("w")&&(this.speed=1,this.move(new i(0,-1))),t.state.get("s")&&(this.speed=1,this.move(new i(0,1))),t.state.get("a")&&(this.speed=1,this.move(new i(-1,0))),t.state.get("d")&&(this.speed=1,this.move(new i(1,0)));for(let e=0;e<this.bullets.length;e++){const s=this.bullets[e];s.update(),s.active||(this.bullets.splice(e,1),e--)}}}class B{entities=[];effects=[];ray;casting;traced=[];limit;emitter=new S;player;control;constructor(t){this.entities=[],this.effects=[],this.ray=new y(new i(400,300),new i(-.5,-.9)),this.casting=new I(this),this.limit=5,this.control=new D(t,this.emitter),this.player=new O(new i(400,300),2,this)}add(t){return this.entities.push(t),this}update(){for(const t of this.entities)t.update();for(let t=0;t<this.effects.length;t++)this.effects[t].update(),this.effects[t].value>=this.effects[t].end&&(this.effects.splice(t,1),t--);this.player.update(),this.trace()}trace(){this.traced=this.casting.cast(this.player.ray,this.limit)}}class C{renderer;world;constructor(t){this.world=new B(t),this.renderer=new k(t,this.world)}start(){this.world.control.subscribe(),this.world.player.subscribe(),this.renderer.start()}stop(){this.world.control.unsubscribe(),this.world.player.unsubscribe(),this.renderer.stop()}}const x=document.getElementById("app");if(!x)throw new Error("No canvas element found");const v=new C(x),f=v.world;f.add(r.line(new i(1,1),new i(799,1))).add(r.line(new i(1,599),new i(799,599))).add(r.line(new i(1,1),new i(1,599))).add(r.line(new i(799,1),new i(799,599)));f.add(r.line(new i(40,40),new i(300,20))).add(r.line(new i(300,20),new i(500,30))).add(r.line(new i(500,30),new i(750,10))).add(r.line(new i(750,10),new i(790,250))).add(r.line(new i(790,250),new i(750,300))).add(r.line(new i(750,300),new i(790,350))).add(r.line(new i(790,350),new i(780,590))).add(r.line(new i(780,590),new i(600,550))).add(r.line(new i(600,550),new i(400,560))).add(r.line(new i(400,560),new i(200,595))).add(r.line(new i(200,595),new i(190,500))).add(r.line(new i(190,500),new i(150,595))).add(r.line(new i(150,595),new i(30,490))).add(r.line(new i(30,490),new i(50,290))).add(r.line(new i(50,290),new i(10,140))).add(r.line(new i(10,140),new i(40,40)));const M=r.square(new i(250,250),75),E=r.square(new i(450,450),90),L=r.square(new i(550,200),90);M.rotation=-.01;E.rotation=.02;L.rotation=.005;f.add(M).add(E).add(L);const K=r.polygon([new i(100,100),new i(150,50),new i(50,100)]);f.add(K);document.getElementById("limit")?.addEventListener("input",c=>{const t=c.target,e=parseInt(t.value,10);isNaN(e)||(f.limit=e)});v.start();
